AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: "collie-smart-tv-webpage\nHosting est\xE1tico para la web de App TV (S3\
  \ + CloudFront)\n"
Parameters:
  AppDomainName:
    Type: String
    Description: "Dominio completo de la aplicaci\xF3n (ej. stage.apptv.com.ar o www.apptv.com.ar)"
  CertificateArn:
    Type: String
    Description: ARN del certificado ACM en us-east-1 para el dominio (Dejar en blanco
      si no se usa HTTPS personalizado por ahora/para dev)
    Default: ''
Conditions:
  HasCustomDomain:
    Fn::Not:
    - Fn::Equals:
      - Ref: AppDomainName
      - ''
  HasCertificate:
    Fn::Not:
    - Fn::Equals:
      - Ref: CertificateArn
      - ''
  EnableCustomDomain:
    Fn::And:
    - Condition: HasCustomDomain
    - Condition: HasCertificate
Resources:
  WebsiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Fn::Sub: ${AppDomainName}-content
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
  CloudFrontOAI:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment:
          Fn::Sub: OAI for ${AppDomainName}
  WebsiteBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: WebsiteBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            CanonicalUser:
              Fn::GetAtt:
              - CloudFrontOAI
              - S3CanonicalUserId
          Action: s3:GetObject
          Resource:
            Fn::Sub: arn:aws:s3:::${WebsiteBucket}/*
  WebsiteDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Origins:
        - DomainName:
            Fn::GetAtt:
            - WebsiteBucket
            - DomainName
          Id:
            Fn::Sub: S3-${WebsiteBucket}
          S3OriginConfig:
            OriginAccessIdentity:
              Fn::Sub: origin-access-identity/cloudfront/${CloudFrontOAI}
        Enabled: true
        DefaultRootObject: index.html
        Aliases:
          Fn::If:
          - EnableCustomDomain
          - - Ref: AppDomainName
          - Ref: AWS::NoValue
        ViewerCertificate:
          Fn::If:
          - HasCertificate
          - AcmCertificateArn:
              Ref: CertificateArn
            SslSupportMethod: sni-only
            MinimumProtocolVersion: TLSv1.2_2021
          - CloudFrontDefaultCertificate: true
        DefaultCacheBehavior:
          AllowedMethods:
          - GET
          - HEAD
          - OPTIONS
          CachedMethods:
          - GET
          - HEAD
          - OPTIONS
          TargetOriginId:
            Fn::Sub: S3-${WebsiteBucket}
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
          ViewerProtocolPolicy: redirect-to-https
          MinTTL: 0
          DefaultTTL: 3600
          MaxTTL: 86400
          Compress: true
        CustomErrorResponses:
        - ErrorCode: 403
          ResponseCode: 200
          ResponsePagePath: /index.html
        - ErrorCode: 404
          ResponseCode: 200
          ResponsePagePath: /index.html
Outputs:
  WebsiteURL:
    Description: URL de CloudFront
    Value:
      Fn::GetAtt:
      - WebsiteDistribution
      - DomainName
  BucketName:
    Description: Nombre del Bucket S3 de origen
    Value:
      Ref: WebsiteBucket
